variable "region" {
    type    = string
    default = "eu-central-1"
}

locals { 
    timestamp = regex_replace(timestamp(), "[- TZ:]", "") 
}

source "amazon-ebs" "metasploitable3-ub1404" {  
    ami_name        = "metasploitable3"  
    ami_description = "Metasploitable3-${local.timestamp}"  
    instance_type   = "t2.small"  
    region          = var.region  
    source_ami_filter {    
        filters = {      
            name                = "*ubuntu-trusty-daily-amd64-server*"  
            root-device-type    = "ebs"      
            virtualization-type = "hvm"   
        }    
        most_recent = true    
        owners      = ["099720109477"]  
    }  
    ssh_username = "ubuntu"

    // remove previous built-images (dev phase)
    // https://www.packer.io/docs/builders/amazon/ebs
    force_deregister = true
    force_delete_snapshot = true
}

build {  
    sources = ["source.amazon-ebs.metasploitable3-ub1404"]
    name = "metasploitable3"
  
    provisioner "chef-solo" {
        cookbook_paths = ["cookbooks"]
        run_list = [
            "apt::default",
            "iptables::default",
            "metasploitable::users",
            "metasploitable::log4shell",
            "metasploitable::mysql",
            "metasploitable::apache_continuum",
            "metasploitable::apache",
            "metasploitable::php_545",
            "metasploitable::phpmyadmin",
            "metasploitable::proftpd",
            "metasploitable::docker",
            "metasploitable::samba",
            "metasploitable::sinatra",
            "metasploitable::unrealircd",
            "metasploitable::chatbot",
            "metasploitable::payroll_app",
            "metasploitable::readme_app",
            "metasploitable::cups",
            "metasploitable::drupal",
            "metasploitable::knockd",
            "metasploitable::iptables",
            "metasploitable::flags",
            "metasploitable::sshd",
            "metasploitable::clear_cache"
        ]

    }

    provisioner "shell" {    
        inline = [
            "sudo apt-get -y remove chef"
        ]
    }
}

